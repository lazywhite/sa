## devicetype
SELECT user_id,plat_id,CAST(FROM_UNIXTIME(reg_ts) AS DATE)reg_ts,CAST(FROM_UNIXTIME(last_login_ts) AS DATE)last_login_ts,device_type,
(SELECT * FROM PiLi_ConfigDB.dic_servername)serverid
FROM T_USER 
WHERE last_login_ts>=UNIX_TIMESTAMP(DATE_ADD(CURDATE(),INTERVAL -1 DAY))
AND last_login_ts<UNIX_TIMESTAMP(CURDATE()); 



# t_user 
SELECT user_id,plat,plat_id,user_name,user_lv,user_exp,coins,power_value,update_ts,CAST(FROM_UNIXTIME(reg_ts) AS datetime) reg_date,CAST(FROM_UNIXTIME(reg_ts) AS datetime) act_date
,last_login_ts,last_rush_ts,award_version,(SELECT * FROM PiLi_ConfigDB.dic_servername)serverid
FROM T_USER
WHERE CAST(FROM_UNIXTIME(reg_ts) AS datetime)>=DATE_ADD(CURDATE(),INTERVAL -1 DAY) AND CAST(FROM_UNIXTIME(reg_ts) AS datetime)<CURDATE();


#  t_user_charge
SELECT *,(SELECT * FROM PiLi_ConfigDB.dic_servername)serverid
FROM PiLi_GameDB.T_USER_CHARGE
WHERE create_ts>=DATE_ADD(CURDATE(),INTERVAL -1 DAY) AND create_ts<CURDATE();




BEGIN

	DECLARE v_tbl CHAR(8);
	DECLARE v_dt INT;
	DECLARE v_n_dt INT;
	SET v_dt = UNIX_TIMESTAMP(DATE_ADD(CURDATE(),INTERVAL -1 DAY));
	SET v_n_dt = UNIX_TIMESTAMP(CURDATE());
	SET v_tbl=REPLACE(DATE_ADD(CURDATE(),INTERVAL -1 DAY),'-','');
	TRUNCATE TABLE t_log;
	
	SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
	SET SESSION bulk_insert_buffer_size = 1*1024*1024*1024;
	
	# 昨日活跃用户
	SET AUTOCOMMIT=0;
		SET @a=CONCAT('INSERT INTO t_log(user_id,reg_ts,log_ts)',' SELECT DISTINCT user_id,DATE_ADD(CURDATE(),INTERVAL -1 DAY) reg_ts,CAST(FROM_UNIXTIME(log_ts)AS DATE)log_ts',
		' FROM PiLi_LogDB.T_LOG_',v_tbl,'  WHERE user_id>=1 ',' AND log_ts< ',v_n_dt);
		PREPARE cmd FROM @a;
		
		EXECUTE cmd;
		DEALLOCATE PREPARE cmd;
	COMMIT;

END

################

BEGIN

	# gmt_time = yesterday
	SET @gmt_time=DATE_ADD(CURDATE(),INTERVAL -1 DAY); 

	## 全服注册玩家总数
	SET @a=CONCAT('SELECT COUNT(0) INTO @total_regs FROM PiLi_GameDB.T_USER WHERE CAST(FROM_UNIXTIME(reg_ts) AS datetime)<CURDATE();');
	PREPARE cmd FROM @a;  

	EXECUTE cmd;
	

	# 昨天注销的用户数
	SET @b=CONCAT('SELECT COUNT(0) INTO @act_regs FROM PiLi_GameDB.T_USER WHERE CAST(FROM_UNIXTIME(logout_ts) AS datetime)>=DATE_ADD(CURDATE(),INTERVAL -1 DAY) AND CAST(FROM_UNIXTIME(logout_ts) AS datetime)<CURDATE();');  
	PREPARE cmd FROM @b;
	EXECUTE cmd;

	

	 # 昨天注册的玩家数
	 SET @c=CONCAT('SELECT COUNT(0) INTO @day_regs
	 FROM PiLi_GameDB.T_USER WHERE CAST(FROM_UNIXTIME(reg_ts) AS datetime)>=DATE_ADD(CURDATE(),INTERVAL -1 DAY) AND CAST(FROM_UNIXTIME(reg_ts) AS datetime)<CURDATE();');
	 PREPARE cmd FROM @c;
	 EXECUTE cmd;


	# 全服总充值数量, 总付费用户数, 总充值笔数
	SET @d=CONCAT('SELECT SUM(amount),COUNT(DISTINCT user_id),COUNT(0) INTO @total_amount,@total_pay_users,@total_pay_num
	FROM PiLi_GameDB.T_USER_CHARGE WHERE create_ts<CURDATE();');
	PREPARE cmd FROM @d;
	EXECUTE cmd;

	# 昨日总充值, 总付费用户, 总充值笔数
	SET @e=CONCAT('SELECT SUM(amount),COUNT(DISTINCT user_id),COUNT(0) INTO 
	@day_amount, @day_pay_users,@day_pay_num
	FROM PiLi_GameDB.T_USER_CHARGE WHERE create_ts>=DATE_ADD(CURDATE(),INTERVAL -1 DAY) AND create_ts<CURDATE();');
	PREPARE cmd FROM @e;
	EXECUTE cmd;
	DEALLOCATE PREPARE cmd;
	
	IF @total_regs>0 THEN
		INSERT INTO t_user_loadinfo(gmt_time,total_regs,act_regs,day_regs,total_amount,total_pay_users,total_pay_num,day_amount,day_pay_users,day_pay_num)
		SELECT @gmt_time,@total_regs,@act_regs,@day_regs,@total_amount,@total_pay_users,@total_pay_num,@day_amount,@day_pay_users,@day_pay_num;
	END IF;
END