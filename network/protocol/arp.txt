1. vlan会隔离arp广播
2. 当ip和网段完全一致时, 比如192.168.1.4/24, 主机才会响应ARP广播
3. ARP的目的是建立L2与L3的映射关系, 多个IP可以有相同mac, 因此ARP table的每个entry是IP-->MAC
4. arp是拿已知的ip询问其mac
5. arp广播只存在于局域网，路由器会隔离arp广播


####### 1. 基本功能 #############
在以太网协议中规定，同一局域网中的一台主机要和另一台主机进行直接通信，必须要知道目标主机的MAC地址。而在TCP/IP协议中，网络层和传输层只关心目标主机的IP地址。这就导致在以太网中使用IP协议时，数据链路层的以太网协议接到上层IP协议提供的数据中，只包含目的主机的IP地址。于是需要一种方法，根据目的主机的IP地址，获得其MAC地址。这就是ARP协议要做的事情。所谓地址解析（address resolution）就是主机在发送帧前将目标IP地址转换成目标MAC地址的过程。

另外，当发送主机和目的主机不在同一个局域网中时，即便知道对方的MAC地址，两者也不能直接通信，必须经过路由转发才可以。所以此时，发送主机通过ARP协议获得的将不是目的主机的真实MAC地址，而是一台可以通往局域网外的路由器的MAC地址。于是此后发送主机发往目的主机的所有帧，都将发往该路由器，通过它向外发送。这种情况称为委托ARP或ARP代理（ARP Proxy）。

在点对点链路中不使用ARP，实际上在点对点网络中也不使用MAC地址，因为在此类网络中分别已经获取了对端的IP地址。


##### 结论 ######
只有在同一个网段时, 才需要知道对方真实mac，跨网段只需知道路由器的mac
要想进行通信，必须有对方mac, 否则icmp也不通

####### 2. 工作原理 #############

以主机A（192.168.38.10）向主机B（192.168.38.11）发送数据为例。
1.当发送数据时，主机A会在自己的ARP缓存表中寻找是否有目标IP地址。如果找到就知道目标MAC地址为（00-BB-00-62-C2-02），直接把目标MAC地址写入帧里面发送就可。
2.如果在ARP缓存表中没有找到相对应的IP地址，主机A就会在网络上发送一个广播（ARP request），目标MAC地址是“FF.FF.FF.FF.FF.FF”，这表示向同一网段内的所有主机发出这样的询问：“192.168.38.11的MAC地址是什么？”

3.网络上其他主机并不响应ARP询问，只有主机B接收到这个帧时，才向主机A做出这样的回应（ARP response）：“192.168.38.11的MAC地址是00-BB-00-62-C2-02”，此回应以单播方式。这样，主机A就知道主机B的MAC地址，它就可以向主机B发送信息。同时它还更新自己的ARP高速缓存（ARP cache），下次再向主机B发送信息时，直接从ARP缓存表里查找就可。
ARP缓存表采用老化机制，在一段时间内如果表中的某一行没有使用，就会被删除，这样可减少缓存表的长度，加快查询速度。


免费ARP（gratuitous ARP），他是指主机发送ARP查询（广播）自己的IP地址，当ARP功能被开启或者是端口初始配置完成，主机向网络发送免费ARP来查询自己的IP地址确认地址唯一可用。

作用:
    确定网络中是否有其他主机使用了IP地址，如果有应答则产生错误消息。
    免费ARP可以做更新ARP缓存用，网络中的其他主机收到该广播则在缓存中更新条目，收到该广播的主机无论是否存在与IP地址相关的条目都会强制更新，如果存在旧条目则会将MAC更新为广播包中的MAC

##### 2结论 ######
arp就是广播询问某个ip的mac是什么
gratuitous arp就是向别人广播某个ip的mac是什么




#### issue1 ######
同一台交换机，同一个vlan, 不同网段， 能否通信
host1: 1.0.0.1/8
host2: 2.0.0.1/8

因为跨网段, 需要三层转发，如果交换机支持路由，并且路由配置正确，才可以通过arp获取host2 mac进行通信




### 工作流程 ####
1. 当dst ip与src ip是同一个网段时，一般已有一个路由entry(192.168.0.1/24 dev eth0), arp包通过eth0进入交换机，交换机转发arp广播，dst以单播回应
2. 当dst ip与src ip不在同一个网段时, 需要走默认网关，先通过arp拿到网关地址，然后直接组装L2 header向router发packet，router会解析L3进行转发
